# This file is a template, and might need editing before it works on your project.
docker-build-master:
  # Official docker image.
  image: docker:latest
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - echo "$CI_COMMIT_REF_SLUG"
  script:
    - docker build --pull -t registry.gitlab.com/hub-smarthis/portal:manager .
    - docker build --pull -t registry.gitlab.com/hub-smarthis/portal:nginx ./nginx
    - docker push registry.gitlab.com/hub-smarthis/portal:manager
    - docker push registry.gitlab.com/hub-smarthis/portal:nginx
  tags:
    - build
  only:
    - master

# This file is a template, and might need editing before it works on your project.
docker-build:
  # Official docker image.
  image: docker:latest
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - echo "$CI_COMMIT_REF_SLUG"
  script:
    - docker build --pull -t "registry.gitlab.com/hub-smarthis/portal:manager-$CI_COMMIT_REF_SLUG" .
    - docker build --pull -t "registry.gitlab.com/hub-smarthis/portal:nginx-$CI_COMMIT_REF_SLUG" ./nginx
    - docker push "registry.gitlab.com/hub-smarthis/portal:manager-$CI_COMMIT_REF_SLUG"
    - docker push "registry.gitlab.com/hub-smarthis/portal:nginx-$CI_COMMIT_REF_SLUG"
  tags:
    - homolog
  except:
    - master


deploy-homolog:
  stage: deploy
  variables:
    DOMAIN: "prod.smarthis.com.br"
    IMAGE_SUFIX: "-$CI_COMMIT_REF_SLUG"
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - echo "$CI_COMMIT_REF_SLUG"
  script:
    - docker stack deploy manager -c docker-compose-prod.yml --with-registry-auth
  tags:
    - homolog
  except:
    - master


deploy-production:
  stage: deploy
  variables:
    DOMAIN: "hub.smarthis.com.br"
    IMAGE_SUFIX: "" #empty
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - echo "$CI_COMMIT_REF_SLUG"
  script:
    - docker stack deploy manager -c docker-compose-prod.yml  --with-registry-auth
  tags:
    - production
  only:
    - master
